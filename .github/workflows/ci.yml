name: Node.js CI/CD Pipeline

on:
  push:
    branches:
      - '**'          # run CI on all branches (main, develop, lint-fix, etc.)
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ─────────────────────────────
  # STAGE 1: BUILD (INSTALL DEPS)
  # ─────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

  # ────────────────
  # STAGE 2: LINT
  # ────────────────
  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx eslint . --format=json --output-file lint-report.json || true

      - name: Upload Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.json

  # ────────────────
  # STAGE 3: TEST
  # ────────────────
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Jest tests
        run: npx jest --ci

  # ─────────────────
  # STAGE 4: COVERAGE
  # ─────────────────
  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Jest with coverage
        run: npx jest --ci --coverage --reporters=default

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/   # Jest's default coverage folder

  # ─────────────────
  # STAGE 5: SECURITY
  # ─────────────────
  security:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high --json > security-report.json || true

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # ─────────────────────────────
  # CD: PACKAGE / DEPLOY ARTIFACT
  # ─────────────────────────────
  CD:
    runs-on: ubuntu-latest
    needs: [build, lint, test, coverage, security]
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all CI artifacts
        uses: actions/download-artifact@v4

      - name: Create deployment artifact (.zip)
        run: |
          mkdir -p deployment/reports

          # Move reports into deployment folder
          mv coverage-report deployment/reports/coverage-report
          mv lint-report/lint-report.json deployment/reports/lint-report.json
          mv security-report/security-report.json deployment/reports/security-report.json

          # Copy project files into deployment folder
          cp -r client deployment/client
          cp -r tests deployment/tests
          cp package.json package-lock.json README.md deployment/

          # Zip everything
          zip -r deployment-package.zip deployment

      - name: Upload final deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip
