name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # JOB 1: BUILD (Stage 1)
  # This job just checks that the project builds
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      # We just run install here to make sure it works
      - name: 1. Build - Install Dependencies
        run: npm ci

  # JOB 2: LINT (Stage 4)
  # Runs in parallel with Test and Security
  lint:
    runs-on: ubuntu-latest
    needs: build # Waits for 'build' to finish
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      # FIX: Install dependencies fresh in this job
      - name: Install Dependencies
        run: npm ci
          
      - name: 4. Lint - Run ESLint
        run: npx eslint . --format=json --output-file lint-report.json || true
      
      - name: 4. Lint - Upload Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.json

  # JOB 3: TEST & COVERAGE (Stages 2 & 3)
  # Runs in parallel with Lint and Security
  test-and-coverage:
    runs-on: ubuntu-latest
    needs: build # Waits for 'build' to finish
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      # FIX: Install dependencies fresh in this job
      - name: Install Dependencies
        run: npm ci
          
      - name: 2&3. Test & Coverage - Run Jest
        run: npx jest --ci --coverage --reporters=default
      
      - name: 3. Coverage - Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # JOB 4: SECURITY (Stage 5)
  # Runs in parallel with Lint and Test
  security:
    runs-on: ubuntu-latest
    needs: build # Waits for 'build' to finish
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      # FIX: Install dependencies fresh in this job
      - name: Install Dependencies
        run: npm ci
          
      - name: 5. Security - Run NPM Audit
        run: npm audit --audit-level=high --json > security-report.json || true
      
      - name: 5. Security - Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # JOB 5: DEPLOYMENT ARTIFACT
  # This job now waits for ALL 4 previous jobs to succeed
  cd-pipeline:
    runs-on: ubuntu-latest
    needs: [build, lint, test-and-coverage, security] # Waits for all CI jobs
    if: github.event_name == 'push' # Only on push
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all CI Artifacts
        uses: actions/download-artifact@v4
        # This will download all artifacts (reports) from the previous jobs
      
      - name: Create Deployment Artifact (.zip)
        run: |
          mkdir -p deployment/reports # Create folder for reports
          
          # Move reports into the deployment folder
          mv lint-report/lint-report.json deployment/reports/
          mv coverage-report deployment/reports/coverage-report
          mv security-report/security-report.json deployment/reports/
          
          # Copy the entire client folder
          cp -r client deployment/client
          
          # Copy the tests folder
          cp -r tests deployment/tests
          
          # Copy all the important root-level files
          cp .gitignore deployment/ || true
          cp eslint.config.js deployment/ || true
          cp jest.config.js deployment/ || true
          cp package-lock.json deployment/ || true
          cp package.json deployment/ || true
          cp README.md deployment/ || true
          
          # Create the final zip
          zip -r deployment-package.zip deployment
      
      - name: Upload Final Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip