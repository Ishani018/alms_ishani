name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  release:
    types: [ created ]

jobs:
  # Continuous Integration - Test & Coverage
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint || echo "Linter completed with warnings"
      continue-on-error: true
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Verify coverage thresholds
      run: |
        npm test -- --coverage --coverageThreshold='{"global":{"statements":75,"branches":75,"functions":75,"lines":75}}'
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-node-${{ matrix.node-version }}
        path: coverage/
        retention-days: 30
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      continue-on-error: true

  # Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Verify application loads
      run: |
        node -e "const app = require('./app'); console.log('âœ“ App loaded successfully');"
    
    - name: Security audit
      run: npm audit --audit-level=moderate || true
      continue-on-error: true

  # Continuous Deployment - Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'release'
    environment:
      name: production
      url: https://your-app-url.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --production=false
    
    - name: Run final tests
      run: npm test
    
    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p deploy
        cp -r app.js server.js config controllers models routes public package.json package-lock.json deploy/ 2>/dev/null || true
        echo "âœ“ Deployment package created"
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deploy/
        retention-days: 7
    
    # Uncomment and configure deployment steps as needed:
    
    # Option 1: Deploy to server via SSH
    # - name: Deploy to server via SSH
    #   uses: appleboy/scp-action@master
    #   with:
    #     host: ${{ secrets.DEPLOY_HOST }}
    #     username: ${{ secrets.DEPLOY_USER }}
    #     key: ${{ secrets.DEPLOY_SSH_KEY }}
    #     source: "deploy/*"
    #     target: "/var/www/alms"
    #     script: |
    #       cd /var/www/alms
    #       npm install --production
    #       pm2 restart alms || pm2 start server.js --name alms
    
    # Option 2: Deploy to Heroku
    # - name: Deploy to Heroku
    #   uses: akhileshns/heroku-deploy@v3.12.12
    #   with:
    #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
    #     heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
    #     heroku_email: ${{ secrets.HEROKU_EMAIL }}
    
    # Option 3: Deploy to AWS
    # - name: Configure AWS credentials
    #   uses: aws-actions/configure-aws-credentials@v4
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: us-east-1
    # - name: Deploy to AWS S3/Elastic Beanstalk
    #   run: |
    #     aws s3 sync deploy/ s3://your-bucket/ || echo "Add your AWS deployment commands"
    
    # Option 4: Deploy to Docker/Container Registry
    # - name: Build Docker image
    #   run: docker build -t alms:${{ github.sha }} .
    # - name: Push to container registry
    #   run: docker push alms:${{ github.sha }}
    
    - name: Deployment notification
      run: |
        echo "ðŸš€ Deployment completed successfully!"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"

