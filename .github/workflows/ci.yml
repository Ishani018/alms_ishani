name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:

  # JOB 1: BUILD (Stage 1)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: 1. Build - Install Dependencies
        run: npm ci

  # JOB 2: LINT (Stage 4)
  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Dependencies
        run: npm ci
      - name: 4. Lint - Run ESLint
        # This will fail the job if lint errors are found
        run: npx eslint . --format=json --output-file lint-report.json
      - name: 4. Lint - Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always() # Upload the report even if the lint step failed
        with:
          name: lint-report
          path: lint-report.json

  # JOB 3: TEST & COVERAGE (Stages 2 & 3)
  test-and-coverage:
    runs-on: ubuntu-latest
    needs: build

    # --- THIS IS THE CRITICAL NEW PART ---
    # This creates a temporary MySQL database in a container
    services:
      mysql:
        image: mysql:5.7 # Use a standard MySQL 5.7 image
        env:
          MYSQL_ROOT_PASSWORD: root # Set a password for the test DB
          MYSQL_DATABASE: testdb    # Create a database named 'testdb'
        ports:
          - 3306:3306 # Map the container's port to the runner's port
        # This waits for MySQL to be fully ready before starting the steps
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Dependencies
        run: npm ci
        
      - name: 2&3. Test & Coverage - Run Jest
        # We run Jest, force it to exit (to close open handles), and detect open handles
        run: npx jest --ci --coverage --reporters=default --forceExit --detectOpenHandles
        # We tell our tests how to connect to the new database
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: testdb
          NODE_ENV: test
      
      - name: 3. Coverage - Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always() # Upload the report even if tests failed
        with:
          name: coverage-report
          path: coverage/

  # JOB 4: SECURITY (Stage 5)
  security:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Dependencies
        run: npm ci
      - name: 5. Security - Run NPM Audit
        # This will fail the job if 'high' vulnerabilities are found
        # We pipe to a file *and* use '|| true' so the file is saved, then check the exit code
        run: |
          npm audit --audit-level=high --json > security-report.json || true
          if [ $? -gt 1 ]; then exit 1; fi
      - name: 5. Security - Upload Security Report
        uses: actions/upload-artifact@v4
        if: always() # Upload the report even if audit failed
        with:
          name: security-report
          path: security-report.json

  # JOB 5: DEPLOYMENT ARTIFACT
  cd-pipeline:
    runs-on: ubuntu-latest
    needs: [build, lint, test-and-coverage, security] # Waits for all CI jobs
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all CI Artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Deployment Artifact (.zip)
        run: |
          mkdir -p deployment/reports
          
          # Move downloaded reports (which are in subfolders)
          mv lint-report/lint-report.json deployment/reports/ || true
          mv coverage-report deployment/reports/coverage-report || true
          mv security-report/security-report.json deployment/reports/ || true
          
          # Copy your *actual* project structure
          cp -r public deployment/public || true
          cp -r routes deployment/routes || true
          cp -r controllers deployment/controllers || true
          cp -r models deployment/models || true
          cp -r config deployment/config || true
          cp -r tests deployment/tests || true
          cp app.js deployment/app.js || true
          cp package.json package-lock.json README.md deployment/ || true
          
          # Create the final zip
          zip -r deployment-package.zip deployment
      
      - name: Upload Final Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip
