name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:

  # JOB 1: BUILD (Stage 1)
  # Installs all dependencies needed for other jobs
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: 1. Build - Install Dependencies
        run: npm ci
      # Upload dependencies for other jobs
      - name: Upload node_modules artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-modules
          path: node_modules/

  # JOB 2: LINT (Stage 4)
  # Checks code quality for errors (Threshold: 0 errors)
  lint:
    runs-on: ubuntu-latest
    needs: build # Requires build to be complete
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download node_modules artifact
        uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: node_modules/
      - name: 4. Lint - Run ESLint
        # Fails if lint errors are found (Rubric: 0 errors)
        run: npx eslint . --format=json --output-file lint-report.json
      - name: 4. Lint - Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always() # Upload report even if lint step failed
        with:
          name: lint-report
          path: lint-report.json

  # JOB 3: TEST & COVERAGE (Stages 2 & 3)
  # Runs all tests and checks coverage (Threshold: 75%)
  test-and-coverage:
    runs-on: ubuntu-latest
    needs: build # Requires build to be complete

    # Starts a MySQL database service for this job
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download node_modules artifact
        uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: node_modules/
        
      - name: 2&3. Test & Coverage - Run Jest
        # Runs tests, generates coverage, and creates a JSON test summary
        # Fails if coverage < 75% (defined in jest.config.js)
        # We add '|| true' so the job continues and uploads reports even if tests fail
        run: npx jest --ci --coverage --reporters=default --json --outputFile=test-results.json --forceExit --detectOpenHandles || true
        env:
          # Env vars for tests to connect to the DB service
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: testdb
          NODE_ENV: test
      
      - name: 3. Coverage - Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always() # Upload report even if tests failed
        with:
          name: coverage-report
          path: coverage/

      # This new step uploads the test results summary
      - name: 2. Test - Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.json

  # JOB 4: SECURITY (Stage 5)
  # Scans for high-level vulnerabilities
  security:
    runs-on: ubuntu-latest
    needs: build # Requires build to be complete
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download node_modules artifact
        uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: node_modules/
      - name: 5. Security - Run NPM Audit
        # Fails if 'high' vulnerabilities are found
        run: |
          npm audit --audit-level=high --json > security-report.json || true
          if [ $? -gt 1 ]; then exit 1; fi
      - name: 5. Security - Upload Security Report
        uses: actions/upload-artifact@v4
        if: always() # Upload report even if audit failed
        with:
          name: security-report
          path: security-report.json

  # JOB 5: DEPLOYMENT ARTIFACT
  # Bundles all code and reports into a .zip file
  cd-pipeline:
    runs-on: ubuntu-latest
    # Waits for all CI jobs to pass
    needs: [lint, test-and-coverage, security]
    if: github.event_name == 'push' # Only run on push events
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all CI Artifacts
        uses: actions/download-artifact@v4
        # This downloads all artifacts into separate folders
      
      - name: Create Deployment Artifact (.zip)
        run: |
          mkdir -p deployment/reports
          
          # Move downloaded reports into the reports folder
          mv lint-report/lint-report.json deployment/reports/ || true
          mv coverage-report deployment/reports/coverage-report || true
          mv security-report/security-report.json deployment/reports/ || true
          # This line is new:
          mv test-results/test-results.json deployment/reports/ || true
          
          # Copy your project source code
          cp -r public deployment/public || true
          cp -r routes deployment/routes || true
          cp -r controllers deployment/controllers || true
          cp -r models deployment/models || true
          cp -r config deployment/config || true
          cp -r tests deployment/tests || true
          cp app.js deployment/app.js || true
          cp package.json package-lock.json README.md deployment/ || true
          
          # Create the final zip
          zip -r deployment-package.zip deployment
      
      - name: Upload Final Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip